===================================================================================
                    ğŸ”Œ API INTEGRATION & COMMUNICATION
===================================================================================

ğŸ“– WHAT IS THIS?
---------------
This document explains how different services communicate in the Job Portal.

===================================================================================
                         SECTION 1: ARCHITECTURE OVERVIEW
===================================================================================

SERVICE ARCHITECTURE:
---------------------
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚  React App (Port 5173)
â”‚   (React)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP/REST
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Backend   â”‚  Express Server (Port 8080)
â”‚  (Node.js)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP/REST
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  AI Service â”‚  FastAPI Server (Port 8000)
â”‚  (Python)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â–º OpenAI API (GPT-4)
       â”œâ”€â”€â–º Qdrant (Vector DB, Port 6333)
       â”œâ”€â”€â–º Tavily API (Web Search)
       â””â”€â”€â–º MongoDB (Port 27017)

===================================================================================
                         SECTION 2: FRONTEND â†’ BACKEND
===================================================================================

AUTHENTICATION:
---------------
ğŸ“ FILE: frontend/src/context/AuthContext.jsx

All API calls include JWT token in Authorization header:

axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;

Example: Login
--------------
POST http://localhost:8080/api/auth/login
Headers:
  Content-Type: application/json
Body:
  {
    "email": "user@example.com",
    "password": "password123"
  }

Response:
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": { ... }
  }

Example: Get Jobs
-----------------
GET http://localhost:8080/api/jobs?page=1&limit=6
Headers:
  Authorization: Bearer <JWT_TOKEN>

Response:
  {
    "jobs": [...],
    "total": 92,
    "totalPages": 16,
    "currentPage": 1
  }

Example: Get Interview Prep
----------------------------
GET http://localhost:8080/api/interview/:applicationId
Headers:
  Authorization: Bearer <JWT_TOKEN>

Response:
  {
    "success": true,
    "company_info": "...",
    "interview_rounds": { ... },
    "dsa_prep": { ... },
    ...
  }

ERROR HANDLING:
---------------
Frontend uses axios interceptors:

axios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token expired - redirect to login
      localStorage.removeItem("token");
      window.location.href = "/login";
    }
    return Promise.reject(error);
  }
);

===================================================================================
                         SECTION 3: BACKEND â†’ AI SERVICE
===================================================================================

BASE URL:
---------
const AI_SERVICE_URL = "http://localhost:8001";

TIMEOUTS:
---------
- Regular operations: 30 seconds
- Long operations (interview prep): 5 minutes (300000ms)

Example: Upload Resume
----------------------
ğŸ“ FILE: backend/services/aiService.js

POST http://localhost:8001/pdf/upload
Headers:
  Content-Type: multipart/form-data
Body:
  FormData with PDF file

Response:
  {
    "success": true,
    "pdf_id": "resume_123",
    "message": "PDF uploaded and processed"
  }

Example: Extract Resume Data
-----------------------------
POST http://localhost:8001/rag/extract-resume-data
Headers:
  Content-Type: application/json
Body:
  {
    "pdf_id": "resume_123"
  }

Response:
  {
    "success": true,
    "data": {
      "skills": ["Python", "JavaScript"],
      "experience": [...],
      "education": [...]
    }
  }

Example: Calculate Fit Score
-----------------------------
POST http://localhost:8001/rag/fit-score
Headers:
  Content-Type: application/json
Body:
  {
    "pdf_id": "resume_123",
    "resume_data": { ... },
    "job_data": { ... }
  }

Response:
  {
    "score": 75,
    "breakdown": {
      "skillsMatch": 80,
      "experienceMatch": 70,
      "educationMatch": 90,
      "overallAlignment": 60
    }
  }

Example: Generate Interview Prep
---------------------------------
POST http://localhost:8001/interview/prepare
Headers:
  Content-Type: application/json
Body:
  {
    "resume_data": { ... },
    "job_data": { ... },
    "application_id": "..."
  }

Response:
  {
    "company_info": "...",
    "interview_rounds": { ... },
    "dsa_prep": { ... },
    "system_design_prep": { ... },
    "behavioral_prep": { ... },
    "common_questions": [...]
  }

RETRY LOGIC:
------------
Backend implements retry logic for AI service calls:

async withRetry(operation, retries = 2, delay = 1000) {
  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      if (attempt === retries) throw error;
      await sleep(delay);
      delay *= 2; // Exponential backoff
    }
  }
}

HEALTH CHECKS:
--------------
Backend checks AI service health before operations:

GET http://localhost:8001/health

Response:
  {
    "status": "ok"
  }

===================================================================================
                         SECTION 4: AI SERVICE â†’ EXTERNAL APIs
===================================================================================

OPENAI API:
-----------
ğŸ“ FILE: AI/interview_prep_graph.py, AI/rag_service.py

Used for:
- Resume data extraction
- Fit score calculation
- Interview prep content generation

Example:
--------
from openai import OpenAI
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

response = client.chat.completions.create(
    model="gpt-4o-mini",
    messages=[
        {"role": "system", "content": "You are a job matching expert"},
        {"role": "user", "content": "Calculate fit score..."}
    ]
)

TAVILY API:
-----------
ğŸ“ FILE: AI/tools_service.py

Used for:
- Company research
- Finding interview experiences
- Web search

Example:
--------
from tavily import TavilyClient

tavily_client = TavilyClient(api_key=os.getenv("TAVILY_API_KEY"))
response = tavily_client.search(
    query="Google Software Engineer interview experience",
    search_depth="advanced",
    max_results=5
)

QDRANT:
-------
ğŸ“ FILE: AI/rag_service.py

Used for:
- Storing resume embeddings
- Retrieving relevant chunks for RAG

Example:
--------
from qdrant_client import QdrantClient

qdrant_client = QdrantClient(url="http://localhost:6333")

# Store embedding
qdrant_client.upsert(
    collection_name="resume_chunks",
    points=[PointStruct(id=chunk_id, vector=embedding, payload={"text": chunk})]
)

# Search
results = qdrant_client.search(
    collection_name="resume_chunks",
    query_vector=query_embedding,
    limit=5
)

===================================================================================
                         SECTION 5: DATABASE CONNECTIONS
===================================================================================

MONGODB:
--------
ğŸ“ FILE: backend/server.js, AI/rag_service.py

Connection String:
  mongodb://localhost:27017/jobportal

Collections:
  - users
  - jobs
  - applications
  - resumes
  - fit_scores

Example Connection:
-------------------
const mongoose = require("mongoose");
mongoose.connect("mongodb://localhost:27017/jobportal");

===================================================================================
                         SECTION 6: ERROR HANDLING
===================================================================================

COMMON ERRORS:
--------------

1. Connection Refused (ECONNREFUSED):
   - Cause: Service not running
   - Solution: Start the service
   - Example: AI service not running when backend tries to call it

2. Timeout (ECONNABORTED):
   - Cause: Request took too long
   - Solution: Increase timeout or optimize
   - Example: Interview prep takes > 5 minutes

3. 401 Unauthorized:
   - Cause: Invalid or expired JWT token
   - Solution: Re-login
   - Example: Token expired, user needs to login again

4. 404 Not Found:
   - Cause: Resource doesn't exist
   - Solution: Check ID/URL
   - Example: Application ID doesn't exist

5. 500 Server Error:
   - Cause: Internal server error
   - Solution: Check server logs
   - Example: Database connection failed

===================================================================================
                         SECTION 7: CORS CONFIGURATION
===================================================================================

BACKEND CORS:
-------------
ğŸ“ FILE: backend/server.js

const cors = require("cors");
app.use(cors({
  origin: "http://localhost:5173",  // Frontend URL
  credentials: true
}));

This allows frontend (port 5173) to make requests to backend (port 8080).

===================================================================================
                         SECTION 8: ENVIRONMENT VARIABLES
===================================================================================

BACKEND (.env):
---------------
JWT_SECRET=your-secret-key
MONGODB_URI=mongodb://localhost:27017/jobportal
AI_SERVICE_URL=http://localhost:8001

AI SERVICE (.env):
------------------
OPENAI_API_KEY=sk-...
TAVILY_API_KEY=tvly-...
QDRANT_URL=http://localhost:6333
MONGODB_URI=mongodb://localhost:27017/jobportal

===================================================================================
                              END OF API INTEGRATION NOTES
===================================================================================

Key Takeaways:
- Frontend â†’ Backend: REST API with JWT authentication
- Backend â†’ AI Service: REST API with retry logic
- AI Service â†’ External APIs: OpenAI, Tavily, Qdrant
- All services use HTTP/REST for communication
- Timeouts configured for long-running operations

